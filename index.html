<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#3d2e1e">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Novel Reader">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Novel Reader</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Noto+Sans+JP:wght@400;500;700&family=Josefin+Sans:wght@300;400;600&display=swap');
:root {
  --bg:#f2ede6;
  --paper:#fffdf9;
  --ink:#3d2e1e;
  --accent:#7a9e7e;
  --accent2:#a8c5a0;
  --warm:#c8956c;
  --warm2:#e8c4a0;
  --muted:#a09080;
  --border:#e0d8cc;
  --shadow:rgba(61,46,30,0.10);
  --header:#3d2e1e;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;}

/* HEADER */
header{position:sticky;top:0;z-index:100;background:var(--header);box-shadow:0 2px 16px var(--shadow);}
.header-top{height:54px;display:flex;align-items:center;padding:0 16px;gap:8px;}
.back-btn{background:none;border:none;color:rgba(255,255,255,0.6);font-size:22px;cursor:pointer;padding:4px 8px 4px 0;flex-shrink:0;}
.header-title{font-family:'Josefin Sans',sans-serif;color:var(--accent2);font-size:17px;letter-spacing:0.08em;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.rename-btn{background:none;border:none;color:rgba(255,255,255,0.35);font-size:14px;cursor:pointer;padding:2px 6px;transition:color 0.2s;}
.rename-btn:hover{color:var(--accent2);}
.header-btns{display:flex;gap:6px;flex-shrink:0;}
.btn{padding:7px 13px;border:none;border-radius:20px;background:var(--accent);color:#fff;font-family:'Noto Sans JP',sans-serif;font-size:12px;cursor:pointer;transition:background 0.2s,transform 0.1s;white-space:nowrap;letter-spacing:0.05em;}
.btn:active{transform:scale(0.95);}
.btn-ghost{background:transparent;border:1.5px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.85);}
.btn-ghost:hover{background:rgba(255,255,255,0.1);}
.btn-danger{background:#b05050;}

/* SHELF DOTS */
.shelf-dots{display:flex;align-items:center;gap:5px;padding:7px 16px;overflow-x:auto;scrollbar-width:none;background:rgba(0,0,0,0.15);}
.shelf-dots::-webkit-scrollbar{display:none;}
.dot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,0.15);flex-shrink:0;cursor:pointer;transition:background 0.2s,transform 0.2s;}
.dot.active{background:var(--accent2);transform:scale(1.5);}
.dot.has-books{background:rgba(168,197,160,0.4);}
.dot.active.has-books{background:var(--accent2);}

/* SEARCH */
.search-wrap{padding:12px 16px 6px;}
.search-wrap input{width:100%;padding:10px 16px;border:1.5px solid var(--border);border-radius:20px;background:var(--paper);font-family:'Noto Sans JP',sans-serif;font-size:14px;color:var(--ink);outline:none;transition:border-color 0.2s,box-shadow 0.2s;}
.search-wrap input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(122,158,126,0.15);}

/* BREADCRUMB */
.breadcrumb{padding:8px 16px 0;font-size:11px;color:var(--muted);display:flex;align-items:center;gap:4px;}
.breadcrumb span{cursor:pointer;color:var(--accent);}
.breadcrumb span:hover{text-decoration:underline;}

/* VIEWS */
#viewShelf,#viewFolder,#viewBooks{display:none;padding:10px 16px 80px;}
#viewShelf.active,#viewFolder.active,#viewBooks.active{display:block;}

/* SHELF SWIPE */
#shelfSwipe{display:flex;transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);}
.shelfSlide{min-width:100vw;padding:4px 0;}

/* FOLDER CARD */
.folder-card{
  background:var(--paper);border-radius:16px;padding:16px 16px 12px;margin-bottom:12px;
  box-shadow:0 2px 10px var(--shadow);cursor:pointer;position:relative;overflow:hidden;
  transition:transform 0.15s,box-shadow 0.15s;
  border:1px solid var(--border);
}
.folder-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px var(--shadow);}
.folder-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:5px;background:linear-gradient(180deg,var(--accent),var(--accent2));border-radius:16px 0 0 16px;}
.folder-header{display:flex;align-items:center;gap:10px;}
.folder-icon{font-size:22px;}
.folder-name{font-size:14px;font-weight:700;color:var(--ink);flex:1;letter-spacing:0.02em;}
.folder-count{font-size:11px;color:var(--muted);background:var(--bg);padding:2px 8px;border-radius:10px;}
.folder-memo{font-size:12px;color:var(--muted);margin-top:10px;padding:8px 10px;background:var(--bg);border-radius:8px;line-height:1.6;white-space:pre-wrap;word-break:break-all;}
.folder-actions{display:flex;gap:6px;margin-top:10px;}
.folder-btn{font-size:11px;padding:5px 12px;border-radius:14px;border:1.5px solid var(--border);background:none;color:var(--muted);cursor:pointer;transition:all 0.15s;}
.folder-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(122,158,126,0.08);}
.folder-btn.danger:hover{border-color:#b05050;color:#b05050;background:rgba(176,80,80,0.08);}

/* BOOK GRID */
.book-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;}
.bookTile{
  background:var(--paper);border-radius:14px;padding:12px 10px;
  box-shadow:0 2px 8px var(--shadow);cursor:pointer;
  transition:transform 0.15s,box-shadow 0.15s;
  position:relative;overflow:hidden;user-select:none;
  border:1px solid var(--border);
}
.bookTile:hover{transform:translateY(-2px);box-shadow:0 6px 18px var(--shadow);}
.bookTile::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:linear-gradient(180deg,var(--accent),var(--accent2));border-radius:14px 0 0 14px;}
.bookTile.selected{outline:2.5px solid var(--accent);background:#f0f7f0;}
.bookTile.selected::before{background:var(--accent);}
.book-title{font-size:12px;font-weight:700;line-height:1.5;color:var(--ink);word-break:break-all;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
.book-meta{font-size:10px;color:var(--muted);margin-top:8px;display:flex;align-items:center;justify-content:space-between;}
.book-progress{font-size:10px;color:var(--accent);}
.fav-btn{background:none;border:none;cursor:pointer;font-size:14px;padding:2px;}

/* SELECT BAR */
#selectBar{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--ink);color:#fff;padding:14px 16px;z-index:5000;flex-direction:row;align-items:center;justify-content:space-between;box-shadow:0 -2px 16px var(--shadow);}
#selectBar.show{display:flex;}
#selectCount{font-size:13px;color:rgba(255,255,255,0.75);}
.select-btns{display:flex;gap:6px;}

/* MOVE MODAL */
#moveModal{display:none;position:fixed;inset:0;background:rgba(30,22,14,0.55);backdrop-filter:blur(4px);z-index:8000;align-items:flex-end;}
#moveModal.show{display:flex;}
.move-box{background:var(--paper);border-radius:24px 24px 0 0;width:100%;max-height:70vh;overflow-y:auto;padding:24px 16px 40px;}
.move-box h3{font-size:14px;color:var(--accent);margin-bottom:16px;text-align:center;font-family:'Josefin Sans',sans-serif;letter-spacing:0.1em;}
.shelf-pick-list{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.shelf-pick-item{padding:12px 6px;border-radius:12px;background:#fff;border:1.5px solid var(--border);font-size:12px;text-align:center;cursor:pointer;line-height:1.4;transition:all 0.15s;}
.shelf-pick-item:hover{border-color:var(--accent);background:#f0f7f0;color:var(--accent);}

/* IMPORT */
#importOverlay{display:none;position:fixed;inset:0;background:rgba(30,22,14,0.65);backdrop-filter:blur(6px);z-index:9999;align-items:center;justify-content:center;}
#importOverlay.show{display:flex;}
.import-box{background:var(--paper);border-radius:20px;padding:30px 36px;text-align:center;min-width:290px;box-shadow:0 12px 40px rgba(0,0,0,0.2);}
.import-box h3{font-family:'Josefin Sans',sans-serif;font-size:15px;color:var(--accent);margin-bottom:6px;letter-spacing:0.1em;}
.import-file-name{font-size:11px;color:var(--muted);margin-bottom:16px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:240px;}
.progress-track{width:100%;height:6px;background:var(--bg);border-radius:99px;overflow:hidden;}
.progress-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:99px;transition:width 0.2s ease;}
.import-count{font-size:12px;color:var(--muted);margin-top:10px;}

/* EMPTY */
.empty-state{text-align:center;padding:60px 20px;color:var(--muted);}
.empty-state .icon{font-size:48px;margin-bottom:14px;opacity:0.6;}
.empty-state p{font-size:13px;line-height:1.9;}

/* RECENT */
.recent-section{margin-bottom:16px;}
.recent-label{font-size:11px;font-family:'Josefin Sans',sans-serif;letter-spacing:0.12em;color:var(--muted);padding:0 2px 8px;text-transform:uppercase;}
.recent-item{display:flex;align-items:center;gap:10px;background:var(--paper);border-radius:12px;padding:10px 14px;margin-bottom:8px;box-shadow:0 1px 6px var(--shadow);border:1px solid var(--border);cursor:pointer;transition:transform 0.15s,box-shadow 0.15s;}
.recent-item:hover{transform:translateY(-1px);box-shadow:0 4px 14px var(--shadow);}
.recent-icon{font-size:18px;flex-shrink:0;}
.recent-info{flex:1;min-width:0;}
.recent-title{font-size:13px;font-weight:700;color:var(--ink);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.recent-sub{font-size:11px;color:var(--muted);margin-top:2px;}
.recent-prog{font-size:11px;color:var(--accent);flex-shrink:0;}
.section-divider{height:1px;background:var(--border);margin:4px 0 14px;opacity:0.6;}

/* READER VIEW */
#viewReader{display:none;position:fixed;inset:0;z-index:2000;flex-direction:column;background:var(--paper);}
#viewReader.active{display:flex;}
.r-topbar{background:rgba(61,46,30,0.94);backdrop-filter:blur(8px);display:flex;align-items:center;gap:6px;padding:8px 12px;flex-shrink:0;}
.r-title{font-size:12px;color:rgba(255,255,255,0.75);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:'Josefin Sans',sans-serif;letter-spacing:0.05em;}
.r-btn{padding:5px 11px;border:none;border-radius:14px;background:rgba(255,255,255,0.12);color:#fff;font-size:14px;cursor:pointer;white-space:nowrap;transition:background 0.15s;}
.r-btn:hover{background:rgba(255,255,255,0.22);}
#rPageContent{flex:1;overflow:hidden;position:relative;}
#rPageInner{position:absolute;inset:0;padding:32px 8% 24px;font-family:'Noto Serif JP',serif;font-size:16px;line-height:1.9;white-space:pre-wrap;word-break:break-all;overflow:hidden;color:var(--ink);transition:opacity 0.15s;}
#rTapLeft,#rTapRight{position:absolute;top:0;bottom:0;width:30%;z-index:5;cursor:pointer;}
#rTapLeft{left:0;}#rTapRight{right:0;}
.r-bottombar{background:rgba(61,46,30,0.94);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:space-between;padding:8px 14px;flex-shrink:0;}
.r-nav-btns{display:flex;gap:6px;}
.r-nav-btn{width:44px;height:38px;border:none;border-radius:12px;background:rgba(255,255,255,0.12);color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.15s;}
.r-nav-btn:hover{background:rgba(255,255,255,0.22);}
.r-nav-btn:disabled{opacity:0.3;cursor:default;}
.r-page-info{font-size:12px;color:rgba(255,255,255,0.65);font-family:'Josefin Sans',sans-serif;letter-spacing:0.08em;}
#rSettingPanel{display:none;position:fixed;bottom:70px;right:16px;width:260px;background:var(--paper);border-radius:18px;box-shadow:0 8px 30px rgba(0,0,0,0.18);z-index:6000;padding:20px;border:1px solid var(--border);}
#rSettingPanel h3{font-size:13px;font-weight:700;color:var(--accent);margin-bottom:16px;font-family:'Josefin Sans',sans-serif;letter-spacing:0.1em;}

/* TOAST */
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--ink);color:#fff;padding:10px 22px;border-radius:20px;font-size:13px;opacity:0;pointer-events:none;transition:opacity 0.3s,transform 0.3s;z-index:9000;white-space:nowrap;letter-spacing:0.03em;}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<header>
  <div class="header-top">
    <button class="back-btn" id="backBtn" onclick="goBack()" style="display:none">â€¹</button>
    <span class="header-title" id="headerTitle">ğŸ“– Novel Reader</span>
    <button class="rename-btn" id="renameBtn" onclick="doRename()" title="åå‰å¤‰æ›´">âœï¸</button>
    <div class="header-btns" id="headerBtns">
      <button class="btn btn-ghost" onclick="fileInput.click()">ï¼‹ãƒ•ã‚©ãƒ«ãƒ€</button>
      <button class="btn btn-ghost" onclick="zipInput.click()">ï¼‹ZIP</button>
    </div>
  </div>
  <div class="shelf-dots" id="shelfDots"></div>
</header>

<input type="file" id="fileInput" style="display:none" webkitdirectory multiple>
<input type="file" id="zipInput" style="display:none" accept=".zip" multiple>

<div class="search-wrap"><input id="searchInput" placeholder="ğŸ” æ¤œç´¢â€¦" oninput="onSearch()"></div>
<div class="breadcrumb" id="breadcrumb"></div>

<!-- SHELF VIEW -->
<div id="viewShelf" class="active">
  <div id="shelfSwipe"></div>
</div>

<!-- FOLDER VIEW -->
<div id="viewFolder">
  <div id="recentSection"></div>
  <div id="folderList"></div>
</div>

<!-- BOOKS VIEW -->
<div id="viewBooks">
  <div class="book-grid" id="bookGrid"></div>
</div>

<!-- READER VIEW -->
<div id="viewReader">
  <div class="r-topbar">
    <button class="r-btn" onclick="closeReader()">â€¹</button>
    <div class="r-title" id="rBookTitle">èª­ã¿è¾¼ã¿ä¸­...</div>
    <button class="r-btn" onclick="rToggleSetting()">âš™</button>
    <button class="r-btn" onclick="rSaveBookmark()">ğŸ”–</button>
    <button class="r-btn" onclick="rEditMemo()">ğŸ“</button>
  </div>
  <div id="rPageContent">
    <div id="rTapLeft" onclick="rPrevPage()"></div>
    <div id="rTapRight" onclick="rNextPage()"></div>
    <div id="rPageInner"></div>
  </div>
  <div class="r-bottombar">
    <div class="r-nav-btns">
      <button class="r-nav-btn" id="rBtnPrev" onclick="rPrevPage()">â€¹</button>
      <button class="r-nav-btn" id="rBtnNext" onclick="rNextPage()">â€º</button>
    </div>
    <div class="r-page-info" id="rPageInfo">- / -</div>
  </div>
  <div id="rSettingPanel">
    <h3>âš™ è¡¨ç¤ºè¨­å®š</h3>
    <div class="srow"><div class="slabel">ãƒ•ã‚©ãƒ³ãƒˆ</div>
      <select id="rFontSel" onchange="rApplyStyle()">
        <option value="'Noto Serif JP',serif">æ˜æœä½“</option>
        <option value="'Noto Sans JP',sans-serif">ã‚´ã‚·ãƒƒã‚¯ä½“</option>
      </select></div>
    <div class="srow"><div class="slabel">èƒŒæ™¯è‰²</div>
      <select id="rBgSel" onchange="rApplyStyle()">
        <option value="#fffdf9">å’Œç´™</option>
        <option value="#ffffff">ãƒ›ãƒ¯ã‚¤ãƒˆ</option>
        <option value="#f0f4ff">ãƒšãƒ¼ãƒ«ãƒ–ãƒ«ãƒ¼</option>
        <option value="#fff0f5">ãƒšãƒ¼ãƒ«ãƒ”ãƒ³ã‚¯</option>
        <option value="#f0fff4">ãƒšãƒ¼ãƒ«ã‚°ãƒªãƒ¼ãƒ³</option>
        <option value="#1a1a1a|#e8e0d0">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</option>
      </select></div>
    <div class="srow"><div class="slabel">æ–‡å­—ã‚µã‚¤ã‚º: <span id="rSzVal">16</span>px</div>
      <input type="range" id="rSzSel" min="12" max="28" step="0.5" value="16" oninput="rApplyStyle()"></div>
    <div class="srow"><div class="slabel">è¡Œé–“: <span id="rLhVal">1.9</span></div>
      <input type="range" id="rLhSel" min="1.2" max="3" step="0.1" value="1.9" oninput="rApplyStyle()"></div>
  </div>
</div>

<!-- SELECT BAR -->
<div id="selectBar">
  <div id="selectCount">0å†Šé¸æŠä¸­</div>
  <div class="select-btns">
    <button class="btn btn-ghost" style="font-size:12px;padding:6px 10px" onclick="openMoveModal()">ğŸ“¦ ç§»å‹•</button>
    <button class="btn btn-ghost" style="font-size:12px;padding:6px 10px" onclick="cancelSelect()">å–æ¶ˆ</button>
    <button class="btn btn-danger" style="font-size:12px;padding:6px 10px" onclick="deleteSelected()">ğŸ—‘ å‰Šé™¤</button>
  </div>
</div>

<!-- MOVE MODAL -->
<div id="moveModal" onclick="closeMoveModal()">
  <div class="move-box" onclick="event.stopPropagation()">
    <h3>ğŸ“¦ ç§»å‹•å…ˆã®æœ¬æ£šã‚’é¸æŠ</h3>
    <div class="shelf-pick-list" id="shelfPickList"></div>
  </div>
</div>

<!-- IMPORT PROGRESS -->
<div id="importOverlay">
  <div class="import-box">
    <h3>ğŸ“¥ å–ã‚Šè¾¼ã¿ä¸­...</h3>
    <div class="import-file-name" id="importFileName">æº–å‚™ä¸­</div>
    <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
    <div class="import-count" id="importCount">0 / 0</div>
  </div>
</div>

<div id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script>
/* â•â• DB â•â• */
const STORE="books", META="shelves", FORDER="folderOrder", RECENT="recent";
const SHELF_COUNT=30;
let db, shelfNames=[], currentShelf=0;
let currentFolderSeries=null;
let view="folder"; // folder | books
let selectedIds=new Set(), selectMode=false;
let touchStartX=0, touchStartY=0;
// drag state
let dragEl=null, dragSeries=null, dragOverEl=null;
// folder order cache: {shelfIdx: [series, ...]}
let folderOrderCache={};

const dbReq=indexedDB.open("NovelReaderDB_v5",3);
dbReq.onupgradeneeded=e=>{
  const d=e.target.result;
  if(!d.objectStoreNames.contains(STORE)) d.createObjectStore(STORE,{keyPath:"id",autoIncrement:true});
  if(!d.objectStoreNames.contains(META)) d.createObjectStore(META,{keyPath:"id"});
  if(!d.objectStoreNames.contains(FORDER)) d.createObjectStore(FORDER,{keyPath:"id"});
  if(!d.objectStoreNames.contains(RECENT)) d.createObjectStore(RECENT,{keyPath:"id"});
};
dbReq.onsuccess=e=>{
  db=e.target.result;
  loadMeta().then(()=>{buildDots();renderFolderView();updateDotBooks();});
};
dbReq.onerror=()=>alert("IndexedDB ã‚¨ãƒ©ãƒ¼ã€‚é€šå¸¸ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ãã ã•ã„ã€‚");

/* â•â• META â•â• */
async function loadMeta(){
  return new Promise(res=>{
    db.transaction([META]).objectStore(META).getAll().onsuccess=e=>{
      const saved=e.target.result;
      shelfNames=Array.from({length:SHELF_COUNT},(_,i)=>{
        const f=saved.find(s=>s.id===i);
        return f?f.name:`æœ¬æ£š ${i+1}`;
      });
      res();
    };
  });
}
function saveShelfName(idx,name){
  db.transaction([META],"readwrite").objectStore(META).put({id:idx,name});
}

/* â•â• FOLDER ORDER â•â• */
function loadFolderOrder(shelfIdx){
  return new Promise(res=>{
    db.transaction([FORDER]).objectStore(FORDER).get(shelfIdx).onsuccess=e=>{
      res(e.target.result?e.target.result.order:null);
    };
  });
}
function saveFolderOrder(shelfIdx,order){
  folderOrderCache[shelfIdx]=[...order];
  db.transaction([FORDER],"readwrite").objectStore(FORDER).put({id:shelfIdx,order});
}

/* â•â• RECENT HISTORY â•â• */
function addRecent(book){
  const entry={id:book.id,title:book.title,series:book.series||"æœªåˆ†é¡",shelfIndex:book.shelfIndex||0,bookmarkPage:book.bookmarkPage||0,readAt:Date.now()};
  const tx=db.transaction([RECENT],"readwrite"),os=tx.objectStore(RECENT);
  os.get(book.id).onsuccess=e=>{
    if(e.target.result) os.put({...entry});
    else os.add(entry);
  };
}
function getRecent(){
  return new Promise(res=>{
    db.transaction([RECENT]).objectStore(RECENT).getAll().onsuccess=e=>{
      const all=e.target.result.sort((a,b)=>b.readAt-a.readAt).slice(0,10);
      res(all);
    };
  });
}

/* â•â• UTIL â•â• */
function htmlToText(html){
  return html
    .replace(/<br\s*\/?>/gi,"\n").replace(/<\/p>/gi,"\n").replace(/<hr\s*\/?>/gi,"\n")
    .replace(/<script[\s\S]*?<\/script>/gi,"").replace(/<style[\s\S]*?<\/style>/gi,"")
    .replace(/<[^>]+>/g,"")
    .replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'")
    .replace(/\n{3,}/g,"\n\n").trim();
}
function getFolderName(rel){const p=(rel||"").split("/");return p.length>=2?p[p.length-2]:"æœªåˆ†é¡";}
function parseZipEntry(name){
  const p=name.split("/"),fn=p[p.length-1].replace(/\.[^.]+$/,""),folder=p.length>=2?p[p.length-2]:"";
  if(!folder&&fn.includes("-")){const[s,...r]=fn.split("-");return{series:s.trim(),title:r.join("-").trim()};}
  return{series:folder||"æœªåˆ†é¡",title:fn};
}
function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
function showToast(msg){
  const t=document.getElementById("toast");t.textContent=msg;t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),2200);
}

/* â•â• PROGRESS â•â• */
function showProg(name,done,total){
  document.getElementById("importOverlay").classList.add("show");
  document.getElementById("importFileName").textContent=name;
  document.getElementById("importCount").textContent=`${done} / ${total}`;
  document.getElementById("progressFill").style.width=total>0?(done/total*100)+"%":"0%";
}
function hideProg(){
  document.getElementById("importOverlay").classList.remove("show");
  document.getElementById("progressFill").style.width="0%";
}

/* â•â• DB OPS â•â• */
function addBook(title,series,content,shelfIndex){
  return new Promise(res=>{
    // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆåŒã‚¿ã‚¤ãƒˆãƒ«ï¼‹åŒã‚·ãƒªãƒ¼ã‚ºï¼‹åŒæœ¬æ£šï¼‰
    db.transaction([STORE]).objectStore(STORE).getAll().onsuccess=e=>{
      const exists=e.target.result.some(b=>b.title===title&&b.series===series&&(b.shelfIndex||0)===shelfIndex);
      if(exists){res();return;}
      db.transaction([STORE],"readwrite").objectStore(STORE)
        .add({title,series,content,shelfIndex,bookmarkPage:0,favorite:false,order:Date.now(),folderMemo:""}).onsuccess=res;
    };
  });
}
function getAllBooks(){
  return new Promise(res=>{
    db.transaction([STORE]).objectStore(STORE).getAll().onsuccess=e=>res(e.target.result);
  });
}

/* â•â• IMPORT â•â• */
document.getElementById("fileInput").onchange=async e=>{
  const files=[...e.target.files].filter(f=>f.name.match(/\.(txt|html|htm)$/i));
  if(!files.length){showToast("å¯¾å¿œãƒ•ã‚¡ã‚¤ãƒ«ãªã—");return;}
  let done=0;
  for(const file of files){
    showProg(file.name,done,files.length);
    const raw=await file.text();
    const content=file.name.match(/\.html?$/i)?htmlToText(raw):raw;
    await addBook(file.name.replace(/\.[^.]+$/,""),getFolderName(file.webkitRelativePath||file.name),content,currentShelf);
    showProg(file.name,++done,files.length);
  }
  hideProg();e.target.value="";
  await refreshView();updateDotBooks();
  showToast(`ğŸ“š ${done}å†Šã‚’ã€Œ${shelfNames[currentShelf]}ã€ã«è¿½åŠ `);
};
document.getElementById("zipInput").onchange=async e=>{
  let total=0;
  for(const zipFile of [...e.target.files]){
    showProg(zipFile.name,0,1);
    let zip;try{zip=await JSZip.loadAsync(zipFile);}catch{showToast(`âš  å¤±æ•—: ${zipFile.name}`);continue;}
    const entries=Object.values(zip.files).filter(f=>!f.dir&&f.name.match(/\.(txt|html|htm)$/i));
    let done=0;
    for(const entry of entries){
      showProg(entry.name.split("/").pop(),done,entries.length);
      const raw=await entry.async("string");
      const content=entry.name.match(/\.html?$/i)?htmlToText(raw):raw;
      const{series,title}=parseZipEntry(entry.name);
      await addBook(title,series,content,currentShelf);
      showProg(entry.name.split("/").pop(),++done,entries.length);total++;
    }
  }
  hideProg();e.target.value="";
  await refreshView();updateDotBooks();
  showToast(`ğŸ“¦ ${total}å†Šã‚’ã€Œ${shelfNames[currentShelf]}ã€ã«è¿½åŠ `);
};

/* â•â• VIEW MANAGEMENT â•â• */
function setView(v){
  view=v;
  document.getElementById("viewShelf").classList.toggle("active",false);
  document.getElementById("viewFolder").classList.toggle("active",v==="folder");
  document.getElementById("viewBooks").classList.toggle("active",v==="books");
  document.getElementById("backBtn").style.display=v==="books"?"block":"none";
  document.getElementById("renameBtn").style.display=v==="folder"?"block":"none";
  document.getElementById("headerBtns").style.display=v==="folder"?"flex":"none";
  document.getElementById("searchInput").placeholder=v==="folder"?"ğŸ” ãƒ•ã‚©ãƒ«ãƒ€æ¤œç´¢â€¦":"ğŸ” æœ¬ã‚’æ¤œç´¢â€¦";
  updateBreadcrumb();
}

function updateBreadcrumb(){
  const bc=document.getElementById("breadcrumb");
  if(view==="folder"){bc.innerHTML="";return;}
  let html=`<span onclick="goToFolderView()">${esc(shelfNames[currentShelf])}</span>`;
  if(view==="books"&&currentFolderSeries){
    html+=` â€º ${esc(currentFolderSeries)}`;
  }
  bc.innerHTML=html;
}

function goBack(){
  cancelSelect();
  if(view==="books") goToFolderView();
}

/* â•â• SHELF VIEW â•â• */
function buildShelfSwipe(){
  const sw=document.getElementById("shelfSwipe");
  sw.innerHTML="";
  for(let i=0;i<SHELF_COUNT;i++){
    const s=document.createElement("div");
    s.className="shelfSlide";s.id=`slide${i}`;
    sw.appendChild(s);
  }
}
function buildDots(){
  const wrap=document.getElementById("shelfDots");wrap.innerHTML="";
  for(let i=0;i<SHELF_COUNT;i++){
    const d=document.createElement("div");
    d.className="dot"+(i===currentShelf?" active":"");
    d.onclick=()=>goToShelf(i);d.title=shelfNames[i];
    wrap.appendChild(d);
  }
}
async function updateDotBooks(){
  const books=await getAllBooks();
  const dots=document.getElementById("shelfDots").children;
  for(let i=0;i<SHELF_COUNT;i++){
    dots[i].classList.toggle("has-books",books.some(b=>(b.shelfIndex||0)===i));
  }
}
async function renderShelfView(){
  document.getElementById("headerTitle").textContent="ğŸ“– Novel Reader";
  setView("shelf");
  const books=await getAllBooks();
  const q=(document.getElementById("searchInput").value||"").toLowerCase();
  for(let i=0;i<SHELF_COUNT;i++){
    const slide=document.getElementById(`slide${i}`);
    const shelf=books.filter(b=>(b.shelfIndex||0)===i&&(!q||b.title.toLowerCase().includes(q)||(b.series||"").toLowerCase().includes(q)));
    // ã‚°ãƒ«ãƒ¼ãƒ—
    const groups={};
    shelf.forEach(b=>{const s=b.series||"æœªåˆ†é¡";if(!groups[s])groups[s]=0;groups[s]++;});
    if(!Object.keys(groups).length){
      slide.innerHTML=`<div class="empty-state"><div class="icon">ğŸ“š</div><p>ç©ºã®æœ¬æ£šã§ã™<br>ã‚¹ãƒ¯ã‚¤ãƒ—ã§åˆ‡æ›¿</p></div>`;
      continue;
    }
    slide.innerHTML="";
    Object.entries(groups).forEach(([series,count])=>{
      const d=document.createElement("div");d.className="folder-card";
      d.innerHTML=`<div class="folder-header"><span class="folder-icon">ğŸ“š</span><span class="folder-name">${esc(series)}</span><span class="folder-count">${count}å†Š</span></div>`;
      d.onclick=()=>openFolder(i,series);
      slide.appendChild(d);
    });
  }
  document.getElementById("shelfSwipe").style.transform=`translateX(-${currentShelf*100}vw)`;
}

function goToShelf(idx){
  currentShelf=idx;
  const dots=document.getElementById("shelfDots").children;
  for(let i=0;i<SHELF_COUNT;i++) dots[i].classList.toggle("active",i===idx);
  dots[idx].scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"});
  currentFolderSeries=null;
  renderFolderView();
}

function goToShelfView(){
  currentFolderSeries=null;
  renderShelfView();
}

/* â•â• FOLDER VIEW â•â• */
async function openFolder(shelfIdx,series){
  currentShelf=shelfIdx;currentFolderSeries=series;
  await renderFolderView();
}
async function goToFolderView(){
  currentFolderSeries=null;
  await renderFolderView();
}
async function renderRecent(){
  const sec=document.getElementById("recentSection");
  const items=await getRecent();
  if(!items.length){sec.innerHTML="";return;}
  sec.innerHTML=`<div class="recent-section">
    <div class="recent-label">â˜• æœ€è¿‘èª­ã‚“ã æœ¬</div>
    ${items.map(item=>`
      <div class="recent-item" onclick="openRecentBook(${item.id})">
        <span class="recent-icon">ğŸ“–</span>
        <div class="recent-info">
          <div class="recent-title">${esc(item.title)}</div>
          <div class="recent-sub">${esc(item.series)}</div>
        </div>
        <span class="recent-prog">${item.bookmarkPage>0?`ğŸ”– P.${item.bookmarkPage+1}`:"æœªèª­"}</span>
      </div>`).join("")}
    <div class="section-divider"></div>
  </div>`;
}

async function openRecentBook(id){
  const books=await getAllBooks();
  const book=books.find(b=>b.id===id);
  if(book) openBook(book);
  else showToast("âš  æœ¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
}

async function renderFolderView(){
  document.getElementById("headerTitle").textContent=shelfNames[currentShelf];
  setView("folder");
  renderRecent();
  const books=await getAllBooks();
  const q=(document.getElementById("searchInput").value||"").toLowerCase();
  const shelf=books.filter(b=>(b.shelfIndex||0)===currentShelf);

  const groups={};
  shelf.forEach(b=>{
    const s=b.series||"æœªåˆ†é¡";
    if(!groups[s]) groups[s]={books:[],memo:b.folderMemo||""};
    groups[s].books.push(b);
  });

  const list=document.getElementById("folderList");list.innerHTML="";

  // ä¸¦ã³é †ã‚’å–å¾—ï¼ˆä¿å­˜æ¸ˆã¿é †åº â†’ è‡ªç„¶é †ã§ãƒãƒ¼ã‚¸ï¼‰
  const allSeries=Object.keys(groups);
  let savedOrder=folderOrderCache[currentShelf]||await loadFolderOrder(currentShelf);
  if(savedOrder){
    // ä¿å­˜æ¸ˆã¿é †ã‚’å„ªå…ˆã€æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€ã¯æœ«å°¾ã«è¿½åŠ 
    const ordered=[...savedOrder.filter(s=>allSeries.includes(s))];
    allSeries.filter(s=>!ordered.includes(s))
      .sort((a,b)=>a.localeCompare(b,'ja',{numeric:true,sensitivity:'base'}))
      .forEach(s=>ordered.push(s));
    folderOrderCache[currentShelf]=ordered;
  } else {
    const ordered=allSeries.sort((a,b)=>a.localeCompare(b,'ja',{numeric:true,sensitivity:'base'}));
    folderOrderCache[currentShelf]=ordered;
  }

  const displayOrder=folderOrderCache[currentShelf].filter(s=>!q||s.toLowerCase().includes(q));

  if(!displayOrder.length){
    list.innerHTML=`<div class="empty-state"><div class="icon">ğŸ“š</div><p>ãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
    return;
  }

  displayOrder.forEach(series=>{
    const data=groups[series];
    if(!data)return;
    const d=document.createElement("div");
    d.className="folder-card";
    d.dataset.series=series;
    const memoHtml=data.memo?`<div class="folder-memo">ğŸ“ ${esc(data.memo)}</div>`:"";
    d.innerHTML=`
      <div class="folder-header" onclick="openBooksView('${esc(series)}')">
        <span class="drag-handle" style="font-size:18px;padding:0 8px 0 0;color:#ccc;cursor:grab;touch-action:none">â˜°</span>
        <span class="folder-icon">ğŸ“š</span>
        <span class="folder-name">${esc(series)}</span>
        <span class="folder-count">${data.books.length}å†Š</span>
      </div>
      ${memoHtml}
      <div class="folder-actions">
        <button class="folder-btn" onclick="editFolderMemo(event,'${esc(series)}')">ğŸ“ ãƒ¡ãƒ¢ç·¨é›†</button>
        <button class="folder-btn danger" onclick="deleteFolder(event,'${esc(series)}',${JSON.stringify(data.books.map(b=>b.id))})">ğŸ—‘ å‰Šé™¤</button>
      </div>`;
    // ãƒ‰ãƒ©ãƒƒã‚°è¨­å®š
    setupDrag(d);
    list.appendChild(d);
  });
}

/* â•â• DRAG & DROP â•â• */
function setupDrag(el){
  const handle=el.querySelector(".drag-handle");

  // ã‚¿ãƒƒãƒ
  handle.addEventListener("touchstart",e=>{
    e.stopPropagation();
    dragEl=el;
    dragSeries=el.dataset.series;
    el.style.opacity="0.5";
    el.style.transform="scale(1.02)";
    if(navigator.vibrate)navigator.vibrate(40);
  },{passive:true});

  handle.addEventListener("touchmove",e=>{
    if(!dragEl)return;
    e.preventDefault();
    const touch=e.touches[0];
    const target=document.elementFromPoint(touch.clientX,touch.clientY);
    const card=target?.closest(".folder-card");
    if(card&&card!==dragEl){
      if(dragOverEl&&dragOverEl!==card) dragOverEl.style.borderTop="";
      dragOverEl=card;
      card.style.borderTop="3px solid var(--accent2)";
    }
  },{passive:false});

  handle.addEventListener("touchend",e=>{
    if(!dragEl)return;
    dragEl.style.opacity="";
    dragEl.style.transform="";
    if(dragOverEl){
      dragOverEl.style.borderTop="";
      // é †åºã‚’æ›´æ–°
      const list=document.getElementById("folderList");
      const cards=[...list.querySelectorAll(".folder-card")];
      const fromIdx=cards.indexOf(dragEl);
      const toIdx=cards.indexOf(dragOverEl);
      if(fromIdx!==-1&&toIdx!==-1&&fromIdx!==toIdx){
        const order=folderOrderCache[currentShelf]||[];
        const filtered=order.filter(s=>cards.map(c=>c.dataset.series).includes(s));
        const [moved]=filtered.splice(fromIdx,1);
        filtered.splice(toIdx,0,moved);
        saveFolderOrder(currentShelf,filtered);
        renderFolderView();
      }
    }
    dragEl=null;dragSeries=null;dragOverEl=null;
  },{passive:true});
}

async function editFolderMemo(e,series){
  e.stopPropagation();
  const books=await getAllBooks();
  const folderBooks=books.filter(b=>(b.shelfIndex||0)===currentShelf&&(b.series||"æœªåˆ†é¡")===series);
  const current=folderBooks[0]?.folderMemo||"";
  const newMemo=prompt(`ã€Œ${series}ã€ã®ãƒ¡ãƒ¢`,current);
  if(newMemo===null) return;
  const tx=db.transaction([STORE],"readwrite"),os=tx.objectStore(STORE);
  let done=0;
  folderBooks.forEach(b=>{
    b.folderMemo=newMemo;
    os.put(b).onsuccess=()=>{if(++done===folderBooks.length){renderFolderView();showToast("ğŸ“ ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ");}};
  });
}

async function deleteFolder(e,series,ids){
  e.stopPropagation();
  if(!confirm(`ã€Œ${series}ã€ã®${ids.length}å†Šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  const tx=db.transaction([STORE],"readwrite"),os=tx.objectStore(STORE);
  let done=0;
  ids.forEach(id=>os.delete(id).onsuccess=()=>{if(++done===ids.length){renderFolderView();updateDotBooks();showToast(`ğŸ—‘ ${ids.length}å†Šå‰Šé™¤`);}});
}

/* â•â• BOOKS VIEW â•â• */
async function openBooksView(series){
  currentFolderSeries=series;
  document.getElementById("headerTitle").textContent=series;
  await renderBooksView();
  setView("books");
}
async function renderBooksView(){
  const books=await getAllBooks();
  const q=(document.getElementById("searchInput").value||"").toLowerCase();
  let list=books.filter(b=>(b.shelfIndex||0)===currentShelf&&(b.series||"æœªåˆ†é¡")===currentFolderSeries&&(!q||b.title.toLowerCase().includes(q)));
  list.sort((a,b)=>a.title.localeCompare(b.title,'ja',{numeric:true,sensitivity:'base'}));
  const grid=document.getElementById("bookGrid");grid.innerHTML="";
  if(!list.length){grid.innerHTML=`<div class="empty-state" style="grid-column:1/-1"><div class="icon">ğŸ“–</div><p>æœ¬ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;return;}
  list.forEach(book=>{
    const div=document.createElement("div");
    div.className="bookTile"+(selectedIds.has(book.id)?" selected":"");
    const prog=book.bookmarkPage>0?`ğŸ”– P.${book.bookmarkPage+1}`:"æœªèª­";
    div.innerHTML=`<div class="book-title">${esc(book.title)}</div><div class="book-meta"><span class="book-progress">${prog}</span><button class="fav-btn" onclick="toggleFav(event,${book.id})">${book.favorite?"â­":"â˜†"}</button></div>`;
    div.addEventListener("click",()=>{if(selectMode)toggleSelect(book.id,div);else openBook(book);});
    let pt;
    div.addEventListener("pointerdown",()=>{pt=setTimeout(()=>enterSelectMode(book.id,div),500);});
    div.addEventListener("pointerup",()=>clearTimeout(pt));
    div.addEventListener("pointercancel",()=>clearTimeout(pt));
    grid.appendChild(div);
  });
}

/* â•â• SELECT â•â• */
function enterSelectMode(id,el){selectMode=true;selectedIds.add(id);el.classList.add("selected");updateSelectBar();if(navigator.vibrate)navigator.vibrate(40);}
function toggleSelect(id,el){if(selectedIds.has(id)){selectedIds.delete(id);el.classList.remove("selected");}else{selectedIds.add(id);el.classList.add("selected");}if(!selectedIds.size)cancelSelect();else updateSelectBar();}
function updateSelectBar(){document.getElementById("selectCount").textContent=`${selectedIds.size}å†Šé¸æŠä¸­`;document.getElementById("selectBar").classList.toggle("show",selectedIds.size>0);}
function cancelSelect(){selectMode=false;selectedIds.clear();document.getElementById("selectBar").classList.remove("show");if(view==="books")renderBooksView();}
async function deleteSelected(){
  if(!selectedIds.size)return;
  if(!confirm(`${selectedIds.size}å†Šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;
  const ids=[...selectedIds];
  const tx=db.transaction([STORE],"readwrite"),os=tx.objectStore(STORE);
  let done=0;
  ids.forEach(id=>os.delete(id).onsuccess=()=>{if(++done===ids.length){cancelSelect();renderBooksView();updateDotBooks();showToast(`ğŸ—‘ ${ids.length}å†Šå‰Šé™¤`);}});
}

/* â•â• MOVE â•â• */
function openMoveModal(){
  if(!selectedIds.size)return;
  const list=document.getElementById("shelfPickList");list.innerHTML="";
  for(let i=0;i<SHELF_COUNT;i++){
    if(i===currentShelf)continue;
    const item=document.createElement("div");item.className="shelf-pick-item";
    item.textContent=shelfNames[i];item.onclick=()=>moveToShelf(i);
    list.appendChild(item);
  }
  document.getElementById("moveModal").classList.add("show");
}
function closeMoveModal(){document.getElementById("moveModal").classList.remove("show");}
async function moveToShelf(targetIdx){
  const ids=[...selectedIds];
  const tx=db.transaction([STORE],"readwrite"),os=tx.objectStore(STORE);
  let done=0;
  ids.forEach(id=>{
    os.get(id).onsuccess=ev=>{
      const b=ev.target.result;b.shelfIndex=targetIdx;
      os.put(b).onsuccess=()=>{if(++done===ids.length){closeMoveModal();cancelSelect();renderBooksView();updateDotBooks();showToast(`ğŸ“¦ ã€Œ${shelfNames[targetIdx]}ã€ã«ç§»å‹•`);}}
    };
  });
}

/* â•â• OPEN BOOK (ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ãƒªãƒ¼ãƒ€ãƒ¼) â•â• */
let rBook=null, rPages=[], rCurrentPage=0, rPlaylist=[], rPlaylistIndex=0;
let rResizeTimer;

async function openBook(book){
  addRecent(book);
  const allBooks=await getAllBooks();
  const folderBooks=allBooks
    .filter(b=>(b.shelfIndex||0)===currentShelf&&(b.series||"æœªåˆ†é¡")===(book.series||"æœªåˆ†é¡"))
    .sort((a,b)=>a.title.localeCompare(b.title,'ja',{numeric:true,sensitivity:'base'}));
  const bookIndex=folderBooks.findIndex(b=>b.id===book.id);
  rPlaylist=folderBooks;
  rPlaylistIndex=bookIndex;
  rLoadBook(book);
  document.getElementById("viewReader").classList.add("active");
  history.pushState({reader:true},"");
}

function closeReader(){
  document.getElementById("viewReader").classList.remove("active");
  document.getElementById("rSettingPanel").style.display="none";
  if(view==="books")renderBooksView();
  else renderRecent();
}

function rLoadBook(book){
  rBook=book;
  document.getElementById("rBookTitle").textContent=book.title;
  rApplyStyle();
  setTimeout(()=>{
    rPages=rBuildPages(book.content||"");
    rCurrentPage=Math.min(book.bookmarkPage||0,rPages.length-1);
    rShowPage();
  },60);
}

function rBuildPages(content){
  const el=document.getElementById("rPageInner"),container=document.getElementById("rPageContent");
  const style=window.getComputedStyle(el);
  const padTop=parseFloat(style.paddingTop)||32,padBot=parseFloat(style.paddingBottom)||24;
  const fontSize=parseFloat(el.style.fontSize||style.fontSize)||16;
  const lhRaw=parseFloat(el.style.lineHeight||style.lineHeight);
  const lh=lhRaw<4?lhRaw*fontSize:lhRaw;
  const linesPerPage=Math.max(1,Math.floor((container.clientHeight-padTop-padBot)/lh));
  const charsPerLine=Math.max(1,Math.floor(container.clientWidth*0.84/fontSize));
  const lines=content.split("\n"),result=[];let buf=[],count=0;
  for(const line of lines){
    const dl=Math.max(1,Math.ceil((line.length||0.5)/charsPerLine));
    if(count+dl>linesPerPage&&buf.length>0){result.push(buf.join("\n"));buf=[line];count=dl;}
    else{buf.push(line);count+=dl;}
  }
  if(buf.length)result.push(buf.join("\n"));
  return result.length?result:[""];
}

function rShowPage(){
  const el=document.getElementById("rPageInner");
  el.style.opacity="0";
  setTimeout(()=>{el.textContent=rPages[rCurrentPage]||"";el.style.opacity="1";},100);
  const hasNext=rCurrentPage<rPages.length-1||rPlaylistIndex<rPlaylist.length-1;
  const hasPrev=rCurrentPage>0||rPlaylistIndex>0;
  document.getElementById("rPageInfo").textContent=(rCurrentPage+1)+" / "+rPages.length;
  document.getElementById("rBtnPrev").disabled=!hasPrev;
  document.getElementById("rBtnNext").disabled=!hasNext;
  rAutoSave();
}

function rPrevPage(){
  if(rCurrentPage>0){rCurrentPage--;rShowPage();}
  else if(rPlaylistIndex>0){
    rPlaylistIndex--;
    rLoadBook(rPlaylist[rPlaylistIndex]);
    showToast("â—€ "+rPlaylist[rPlaylistIndex].title);
  }
}
function rNextPage(){
  if(rCurrentPage<rPages.length-1){rCurrentPage++;rShowPage();}
  else if(rPlaylistIndex<rPlaylist.length-1){
    rPlaylistIndex++;
    rLoadBook(rPlaylist[rPlaylistIndex]);
    showToast("â–¶ "+rPlaylist[rPlaylistIndex].title);
  }
}

function rAutoSave(){
  if(!rBook||!db)return;
  const tx=db.transaction([STORE],"readwrite"),os=tx.objectStore(STORE);
  os.get(rBook.id).onsuccess=ev=>{
    if(!ev.target.result)return;
    const b=ev.target.result;b.bookmarkPage=rCurrentPage;os.put(b);
  };
}
function rSaveBookmark(){rAutoSave();showToast("ğŸ”– P."+(rCurrentPage+1)+" ã«ã—ãŠã‚Šã‚’æŒŸã¿ã¾ã—ãŸ");}

function rEditMemo(){
  if(!rBook||!db)return;
  const tx=db.transaction([STORE],"readwrite"),os=tx.objectStore(STORE);
  os.get(rBook.id).onsuccess=ev=>{
    if(!ev.target.result)return;
    const b=ev.target.result;
    const current=b.folderMemo||"";
    const newMemo=prompt("ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ¡ãƒ¢ï¼ˆä½œå“åãƒ»ä½œè€…åãªã©ï¼‰",current);
    if(newMemo===null)return;
    const tx2=db.transaction([STORE],"readwrite"),os2=tx2.objectStore(STORE);
    os2.getAll().onsuccess=e=>{
      const all=e.target.result.filter(x=>x.series===b.series&&(x.shelfIndex||0)===(b.shelfIndex||0));
      let done=0;
      all.forEach(x=>{x.folderMemo=newMemo;os2.put(x).onsuccess=()=>{if(++done===all.length)showToast("ğŸ“ ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ");};});
    };
  };
}

function rApplyStyle(){
  const el=document.getElementById("rPageInner");
  const bgRaw=document.getElementById("rBgSel").value;
  const[bgColor,textColor]=bgRaw.includes("|")?bgRaw.split("|"):[bgRaw,""];
  const sz=document.getElementById("rSzSel").value,lh=document.getElementById("rLhSel").value;
  el.style.fontFamily=document.getElementById("rFontSel").value;
  el.style.fontSize=sz+"px";el.style.lineHeight=lh;el.style.color=textColor||"";
  document.getElementById("rSzVal").textContent=sz;
  document.getElementById("rLhVal").textContent=parseFloat(lh).toFixed(1);
  document.getElementById("rPageContent").style.background=bgColor;
  document.getElementById("viewReader").style.background=bgColor;
  if(rBook&&rPages.length){const old=rCurrentPage;rPages=rBuildPages(rBook.content||"");rCurrentPage=Math.min(old,rPages.length-1);rShowPage();}
}
function rToggleSetting(){const p=document.getElementById("rSettingPanel");p.style.display=p.style.display==="block"?"none":"block";}

// ãƒªãƒ¼ãƒ€ãƒ¼å†…ã‚¹ãƒ¯ã‚¤ãƒ—
let rTsx=0,rTsy=0;
document.getElementById("rPageContent").addEventListener("touchstart",e=>{rTsx=e.touches[0].clientX;rTsy=e.touches[0].clientY;},{passive:true});
document.getElementById("rPageContent").addEventListener("touchend",e=>{
  const dx=e.changedTouches[0].clientX-rTsx;
  const dy=e.changedTouches[0].clientY-rTsy;
  if(Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>50){
    if(dx<0)rNextPage();else rPrevPage();
  }
},{passive:true});

// â–½ æˆ»ã‚‹ãƒœã‚¿ãƒ³å¯¾å¿œ
window.addEventListener("popstate",e=>{
  if(document.getElementById("viewReader").classList.contains("active")){
    closeReader();
  }
});

window.addEventListener("resize",()=>{
  clearTimeout(rResizeTimer);
  rResizeTimer=setTimeout(()=>{if(rBook)rApplyStyle();},300);
});

/* â•â• FAV â•â• */
function toggleFav(e,id){
  e.stopPropagation();
  const tx=db.transaction([STORE],"readwrite"),os=tx.objectStore(STORE);
  os.get(id).onsuccess=ev=>{const b=ev.target.result;b.favorite=!b.favorite;os.put(b).onsuccess=()=>{if(view==="books")renderBooksView();};};
}

/* â•â• SEARCH â•â• */
function onSearch(){
  if(view==="shelf")renderShelfView();
  else if(view==="folder")renderFolderView();
  else if(view==="books")renderBooksView();
}

/* â•â• RENAME â•â• */
function doRename(){
  const n=prompt("æœ¬æ£šã®åå‰",shelfNames[currentShelf]);
  if(!n||!n.trim())return;
  shelfNames[currentShelf]=n.trim();saveShelfName(currentShelf,n.trim());
  document.getElementById("headerTitle").textContent=n.trim();
  document.getElementById("shelfDots").children[currentShelf].title=n.trim();
  showToast("âœï¸ åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
}

/* â•â• REFRESH â•â• */
async function refreshView(){
  if(view==="folder")await renderFolderView();
  else if(view==="books")await renderBooksView();
}

/* â•â• SWIPE â•â• */
document.addEventListener("touchstart",e=>{touchStartX=e.touches[0].clientX;touchStartY=e.touches[0].clientY;},{passive:true});
document.addEventListener("touchend",e=>{
  if(view!=="folder")return;
  const dx=e.changedTouches[0].clientX-touchStartX;
  const dy=e.changedTouches[0].clientY-touchStartY;
  if(Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>60){
    if(dx<0&&currentShelf<SHELF_COUNT-1)goToShelf(currentShelf+1);
    else if(dx>0&&currentShelf>0)goToShelf(currentShelf-1);
  }
},{passive:true});

/* â•â• SERVICE WORKER â•â• */
if('serviceWorker' in navigator && location.protocol !== 'blob:'){
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
}
</script>
</body>
</html>
